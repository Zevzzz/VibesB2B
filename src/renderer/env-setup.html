<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Environment Setup - VibeB2B</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="globals.css">
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function EnvSetup() {
            const [formData, setFormData] = useState({
                GOOGLE_GENERATIVE_AI_API_KEY: '',
                OPENAI_API_KEY: '',
                SLACK_BOT_TOKEN: '',
                DATABASE_URL: '',
                PORT: '4111'
            });
            const [loading, setLoading] = useState(false);
            const [errors, setErrors] = useState({});

            // Load existing data on mount
            useEffect(() => {
                if (window.electronAPI?.getStoredEnv) {
                    window.electronAPI.getStoredEnv().then(data => {
                        if (data) {
                            setFormData(prev => ({ ...prev, ...data }));
                        }
                    }).catch(console.error);
                }
            }, []);

            const handleInputChange = (field, value) => {
                setFormData(prev => ({ ...prev, [field]: value }));
                // Clear error when user starts typing
                if (errors[field]) {
                    setErrors(prev => ({ ...prev, [field]: null }));
                }
            };

            const validateForm = () => {
                const newErrors = {};
                if (!formData.GOOGLE_GENERATIVE_AI_API_KEY.trim()) {
                    newErrors.GOOGLE_GENERATIVE_AI_API_KEY = 'Google AI API Key is required';
                }
                setErrors(newErrors);
                return Object.keys(newErrors).length === 0;
            };

            const handleSubmit = async (e) => {
                e.preventDefault();

                if (!validateForm()) return;

                setLoading(true);
                try {
                    const result = await window.electronAPI.saveEnvVariables(formData);
                    if (result.success) {
                        window.location.href = 'dashboard.html';
                    } else {
                        alert('Failed to save environment variables');
                    }
                } catch (error) {
                    console.error('Error saving:', error);
                    alert('Failed to save environment variables');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-background flex items-center justify-center p-4">
                    <Card className="w-full max-w-md">
                        <CardContent>
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div className="space-y-2">
                                    <Label htmlFor="googleKey">Google AI API Key *</Label>
                                    <Input
                                        id="googleKey"
                                        type="password"
                                        placeholder="AIza..."
                                        value={formData.GOOGLE_GENERATIVE_AI_API_KEY}
                                        onChange={(e) => handleInputChange('GOOGLE_GENERATIVE_AI_API_KEY', e.target.value)}
                                        className={errors.GOOGLE_GENERATIVE_AI_API_KEY ? 'border-red-500' : ''}
                                    />
                                    {errors.GOOGLE_GENERATIVE_AI_API_KEY && (
                                        <p className="text-sm text-red-500">{errors.GOOGLE_GENERATIVE_AI_API_KEY}</p>
                                    )}
                                    <p className="text-xs text-muted-foreground">
                                        Required for Google Gemini AI integration
                                    </p>
                                </div>

                                <div className="space-y-2">
                                    <Label htmlFor="openaiKey">
                                        OpenAI API Key
                                        <span className="text-xs text-muted-foreground ml-1">(Optional)</span>
                                    </Label>
                                    <Input
                                        id="openaiKey"
                                        type="password"
                                        placeholder="sk-..."
                                        value={formData.OPENAI_API_KEY}
                                        onChange={(e) => handleInputChange('OPENAI_API_KEY', e.target.value)}
                                    />
                                    <p className="text-xs text-muted-foreground">
                                        For OpenAI integration
                                    </p>
                                </div>

                                <div className="space-y-2">
                                    <Label htmlFor="slackToken">
                                        Slack Bot Token
                                        <span className="text-xs text-muted-foreground ml-1">(Optional)</span>
                                    </Label>
                                    <Input
                                        id="slackToken"
                                        type="password"
                                        placeholder="xoxb-..."
                                        value={formData.SLACK_BOT_TOKEN}
                                        onChange={(e) => handleInputChange('SLACK_BOT_TOKEN', e.target.value)}
                                    />
                                    <p className="text-xs text-muted-foreground">
                                        For Slack integration and notifications
                                    </p>
                                </div>

                                <div className="space-y-2">
                                    <Label htmlFor="databaseUrl">
                                        Database URL
                                        <span className="text-xs text-muted-foreground ml-1">(Optional)</span>
                                    </Label>
                                    <Input
                                        id="databaseUrl"
                                        type="text"
                                        placeholder="libsql://... or file:./data.db"
                                        value={formData.DATABASE_URL}
                                        onChange={(e) => handleInputChange('DATABASE_URL', e.target.value)}
                                    />
                                    <p className="text-xs text-muted-foreground">
                                        LibSQL database URL. Uses in-memory database if not provided
                                    </p>
                                </div>

                                <div className="space-y-2">
                                    <Label htmlFor="port">
                                        Server Port
                                        <span className="text-xs text-muted-foreground ml-1">(Optional)</span>
                                    </Label>
                                    <Input
                                        id="port"
                                        type="text"
                                        placeholder="4111"
                                        value={formData.PORT}
                                        onChange={(e) => handleInputChange('PORT', e.target.value)}
                                    />
                                    <p className="text-xs text-muted-foreground">
                                        Port for the Mastra server (default: 4111)
                                    </p>
                                </div>

                                <Button type="submit" className="w-full" disabled={loading}>
                                    {loading ? 'Saving...' : 'Save & Continue'}
                                </Button>
                            </form>

                            <div className="mt-6 p-4 bg-muted rounded-lg">
                                <h4 className="text-sm font-medium mb-2">Need API Keys?</h4>
                                <div className="space-y-1 text-xs text-muted-foreground">
                                    <p><a href="https://makersuite.google.com/app/apikey" target="_blank" className="text-primary hover:underline">Google AI API Keys</a></p>
                                    <p><a href="https://platform.openai.com/api-keys" target="_blank" className="text-primary hover:underline">OpenAI API Keys</a></p>
                                    <p><a href="https://api.slack.com/apps" target="_blank" className="text-primary hover:underline">Slack App Setup</a></p>
                                </div>
                            </div>
                        </CardContent>
                    </Card>
                </div>
            );
        }

        // Card Components (simplified inline versions since we can't import them easily)
        function Card({ children, className = "" }) {
            return (
                <div className={`rounded-lg border bg-card text-card-foreground shadow-sm ${className}`}>
                    {children}
                </div>
            );
        }

        function CardHeader({ children, className = "" }) {
            return (
                <div className={`flex flex-col space-y-1.5 p-6 ${className}`}>
                    {children}
                </div>
            );
        }

        function CardTitle({ children, className = "" }) {
            return (
                <h3 className={`text-2xl font-semibold leading-none tracking-tight ${className}`}>
                    {children}
                </h3>
            );
        }

        function CardDescription({ children, className = "" }) {
            return (
                <p className={`text-sm text-muted-foreground ${className}`}>
                    {children}
                </p>
            );
        }

        function CardContent({ children, className = "" }) {
            return (
                <div className={`p-6 pt-0 ${className}`}>
                    {children}
                </div>
            );
        }

        function Button({ children, className = "", ...props }) {
            return (
                <button
                    className={`inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2 ${className}`}
                    {...props}
                >
                    {children}
                </button>
            );
        }

        function Input({ className = "", ...props }) {
            return (
                <input
                    className={`flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 ${className}`}
                    {...props}
                />
            );
        }

        function Label({ children, className = "", ...props }) {
            return (
                <label
                    className={`text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 ${className}`}
                    {...props}
                >
                    {children}
                </label>
            );
        }

        ReactDOM.render(<EnvSetup />, document.getElementById('root'));
    </script>
</body>
</html>